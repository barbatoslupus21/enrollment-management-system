{% extends "main.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}

<div class="banner-content">
    <h4 class="breadcrumbs">Overview</h4>
</div>

<div class="page-content row g-3">
    <!-- Left Column -->
    <div class="col-sm-8 gap-3 d-flex flex-column content" style="height: calc(100vh - 11vh)">
        <!-- Card Counts -->
        <div class="row gx-3">
            <div class="col-md-3 col-sm-3">
                <div class="card metric-card">
                  <div class="card-body d-flex gap-3 align-items-center">
                    <div class="metric-icon-container rounded-circle p-3 mr-3" style="background-color: #5BBCFF;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#e8eaed" class="bi bi-person-fill" viewBox="0 0 16 16">
                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                          </svg>
                    </div>
                    <div class="">
                      <p class="card-subtitle text-muted mb-1">Students</p>
                      <h3 class="card-value font-weight-bold mb-0">{{studentCount}}</h3>
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="col-md-3 col-sm-3">
                <div class="card metric-card">
                  <div class="card-body d-flex gap-3 align-items-center">
                    <div class="metric-icon-container rounded-circle p-3 mr-3" style="background-color: #7EA1FF;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#e8eaed" class="bi bi-people-fill" viewBox="0 0 16 16">
                            <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
                          </svg>
                    </div>
                    <div class="">
                      <p class="card-subtitle text-muted mb-1">Professor</p>
                      <h3 class="card-value font-weight-bold mb-0">{{professorCount}}</h3>
                    </div>
                  </div>
                </div>
            </div>
            
            <div class="col-md-3 col-sm-3">
                <div class="card metric-card">
                  <div class="card-body d-flex gap-3 align-items-center">
                    <div class="metric-icon-container rounded-circle p-3 mr-3" style="background-color: #8576FF;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#e8eaed" class="bi bi-layers-fill" viewBox="0 0 16 16">
                            <path d="M7.765 1.559a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .882l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.882z"/>
                            <path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z"/>
                          </svg>
                    </div>
                    <div class="">
                      <p class="card-subtitle text-muted mb-1">Total Classes</p>
                      <h3 class="card-value font-weight-bold mb-0">{{classesCount}}</h3>
                    </div>
                  </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-3">
                <div class="card metric-card">
                  <div class="card-body d-flex gap-3 align-items-center">
                    <div class="metric-icon-container rounded-circle p-3 mr-3" style="background-color: #F6995C;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#e8eaed" class="bi bi-bookmarks-fill" viewBox="0 0 16 16">
                            <path d="M2 4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v11.5a.5.5 0 0 1-.777.416L7 13.101l-4.223 2.815A.5.5 0 0 1 2 15.5z"/>
                            <path d="M4.268 1A2 2 0 0 1 6 0h6a2 2 0 0 1 2 2v11.5a.5.5 0 0 1-.777.416L13 13.768V2a1 1 0 0 0-1-1z"/>
                          </svg>
                    </div>
                    <div class="">
                      <p class="card-subtitle text-muted mb-1">New Enrollments</p>
                      <h3 class="card-value font-weight-bold mb-0">{{enrolledStudentCount}}</h3>
                    </div>
                  </div>
                </div>
            </div>
        </div>

        <!-- Class Schedule -->
        <div class="card metric-card flex-grow-1">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center pb-2">
                    <h2 class="title-font">Class Schedules</h2>
                    <a href="{% url "professor" %}"><button class="small-button">Manage Class</button></a>
                </div>
                
                <table class="table table-hover shadow-none mt-2">
                    <thead class="open-table-header">
                        <tr>
                            <th class="fw-normal">Subject</th>
                            <th class="fw-normal text-center">Section</th>
                            <th class="fw-normal">Schedule</th>
                            <th class="fw-normal">Professor</th>
                            <th class="fw-normal text-center">Students</th>
                        </tr>
                    </thead>
                    <tbody class="open-table-body open-all-request" id="jo-table">
                        {% for class in classes %}
                        <tr>
                            <td>{{class.section.subject.course_code}}: {{class.section.subject.course_title}}</td>
                            <td class="text-center">{{class.section.section}}</td>
                            <td>{{class.section.day|slice:":3"}} {{class.section.time_from|date:"h:i A"}} - {{class.section.time_to|date:"h:i A"}}</td>
                            <td>{% if class.professor.prof_info.first.name_ext %}{{class.professor.prof_info.first.name_ext}} {% endif %}{{class.section.professor.name}}</td>
                            <td class="text-center">{{class.section.student_section.count}}/{{class.section.capacity}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- For Confirmations -->
        <div class="card metric-card flex-grow-1">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center pb-2">
                    <h2 class="title-font">Recent Enrolled Students</h2>
                    <a href="{% url "enrollment" %}"><button class="small-button">Confirm Enrollment</button></a>
                </div>
                
                <table class="table table-hover shadow-none mt-2">
                    <thead class="open-table-header">                      
                        <tr>
                            <th class="fw-normal">ID Number</th>
                            <th class="fw-normal">Name</th>
                            <th class="fw-normal">Course</th>
                            <th class="fw-normal">Total Units</th>
                            <th class="fw-normal">Total Subjects</th>
                        </tr>
                    </thead>
                    <tbody class="open-table-body open-all-request" id="jo-table">
                        {% for student in enrolledStudents %}
                            <tr>
                                <td>{{student.student.id_number}}</td>
                                <td>{{student.student.name}}</td>
                                <td>{{student.student.student_info.course.course}}</td>
                                <td>{{student_units|get_item:student.student.id}} Units</td>
                                <td>{{student_subjects|get_item:student.student.id}} Subjects</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Right Column -->
    <div class="col-sm-4 gap-3 d-flex flex-column" style="height: calc(100vh - 11vh)">
        <div class="user-statistics-card">
            <div class="user-statistics-header">
              <div>
                <span class="title-font">Registered Students</span>
              </div>
            </div>
        
            <div class="user-statistics-progress-container">
              <svg class="user-statistics-svg" width="240" height="240">
                <circle class="user-statistics-circle user-statistics-background" cx="120" cy="120" r="100"/>
                <circle class="user-statistics-circle user-statistics-progress" cx="120" cy="120" r="100"/>
              </svg>
              <div class="user-statistics-numbers">
                <p class="user-statistics-total">0</p>
                <p class="user-statistics-label">Total Students</p>
              </div>
            </div>
        
            <div class="user-statistics-breakdown">
              <div class="user-statistics-plan">
                <div class="user-statistics-plan-indicator user-statistics-premium-indicator"></div>
                <div class="user-statistics-plan-details">
                  <p class="user-statistics-plan-users user-statistics-premium-count">0</p>
                  <p class="user-statistics-plan-name">Enrolled Student</p>
                </div>
              </div>
              <div class="user-statistics-plan">
                
                <div class="user-statistics-plan-details">
                  <p class="user-statistics-plan-users user-statistics-basic-count">0</p>
                  <p class="user-statistics-plan-name">Registered Student</p>
                </div>
                <div class="user-statistics-plan-indicator user-statistics-basic-indicator"></div>
              </div>
            </div>
        </div>

        <div class="card metric-card">
            <div class="card-body">
                <div class="pb-2">
                    <span class="title-font">Enrollment Percentages</span>
                </div>
                <div class="chart-area">
                    <canvas id="adminOverviewChart" class="chart2nd-Container"></canvas>
                </div>                           
            </div>
        </div>
    </div>
    
</div>

<script>
    // Enrollment Chart
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('adminOverviewChart');
    
        fetch('/admin/api/enrollment-chart/')
            .then(response => response.json())
            .then(data => {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Enrollment %',
                            data: data.data,
                            fill: 'start',
                            backgroundColor: '#01afa93f',
                            borderColor: '#028090',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            pointHitRadius: 100,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return tooltipItem.raw + '%';
                                    }
                                },
                                displayColors: false,
                                bodyFont: {
                                    size: 15
                                },
                                titleFont: {
                                    size: 14
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                min: 0,
                                max: 100,
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    callback: function (value) {
                                        if (value === 100 || value === 50) return value + '%';
                                        return '';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    font: {
                                        family: 'Montserrat',
                                        size: 12
                                    },
                                    color: '#333'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching chart data:', error));
    });

    // Overall Students Graph
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/admin/api/student-statistics/')
            .then(response => response.json())
            .then(data => {
                document.querySelector('.user-statistics-total').textContent = data.total_students;
                document.querySelector('.user-statistics-premium-count').textContent = data.enrolled_students;
                document.querySelector('.user-statistics-basic-count').textContent = data.total_students;
    
                const percentage = data.total_students > 0 
                    ? (data.enrolled_students / data.total_students) * 100 
                    : 0;
    
                const progressCircle = document.querySelector('.user-statistics-progress');
                const circumference = 2 * Math.PI * 100;
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDasharray = `${circumference}`;
                progressCircle.style.strokeDashoffset = offset;
            })
            .catch(error => console.error('Error fetching student statistics:', error));
    });
    
</script>


{% endblock content %}



