{% extends "main.html" %}
{% load static %}

{% block content %}

<div class="banner-content">
    <h4 class="breadcrumbs">Enrollment</h4>
</div>

<div class="page-content row g-3">
    {% if confirmation.status == "Approve" %}
        {% if not progress.subject and not progress.section %}
            <!-- Left Column -->
            <div class="col-sm-9 gap-3 d-flex flex-column" style="height: calc(100vh - 11vh)">
                <div class="card metric-card flex-grow-1">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="title-font pb-3">List of Open Subject for {{request.user.student_info.course.course}}</h2>
                            <div class="search-wrapper">
                                <button class="icon-button" onclick="toggleSearch()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#736b68" class="bi bi-search" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                                </svg>
            
                                </button>
                                <div class="search-input" id="searchContainer">
                                <input type="text" id="searchInput" placeholder="Search..." oninput="searchJO()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- List of subjects -->
                        <div class="subjectsList-container" id="open-subject">
                            {% for subject in subjects %}
                            <div class="subject-card">
                                <div class="subject-card-header">
                                    <div class="d-flex align-items-center">
                                        <div class="subject-icon">ðŸ§ª</div>
                                        <div class="subject-info">
                                            <h4>{{subject.course_code}}: {{subject.course_title}}</h4>
                                            <p>{{subject.course.course}} | {{subject.semester}} | {% if enrolled.is_enrolled %}<span class="text-success">Enrolled</span>{% endif %}</p>
                                        </div>
                                    </div>
                                
                                    <div class="d-flex">
                                        <button class="view-subject small-button">View Section</button>
                                    </div>                                      
                                </div>
                                <div class="subject-card-body">
                                <p>Select a section to enroll:</p>
                                <ul class="section-list">
                                    {% for section in subject.subject_section.all %}
                                    <li>
                                        <div class="section-info">
                                            <strong>{{section.section}}</strong>
                                            <p>Time: {{section.day|slice:":3"}} {{section.time_from|date:"h:i A"}} - {{section.time_to|date:"h:i A"}}</p>
                                            <p>Room: {{section.room}}</p>
                                            {% if section.student_section.first %}
                                                <p class="text-success">Enrolled</p>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex gap-2">
                                            {% if not progress.subject and not progress.section %}
                                                <form method="POST" action="{% url "enroll-section" pk=section.id %}">
                                                    {% csrf_token %}
                                                    {% if section.student_section.first %}
                                                        <button type="submit" name="action" value="remove" class="cancel-button">Remove</button>
                                                    {% else %}
                                                        <button type="submit" name="action" value="add" class="submit-button">Add</button>
                                                    {% endif %}
                                                </form>
                                            {% endif %}
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-end mt-2">
                            <form method="POST" action="{% url "tagging" %}">
                                {% csrf_token %}
                                <button type="submit" class="submit-button">Finish Tagging</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-sm-3 gap-3 d-flex flex-column" style="height: calc(100vh - 11vh)">
                <div class="card metric-card flex-grow-1">
                    <div class="card-body profile-card">
                        <div class="progress-container">
                            <!-- Step 1: Registration -->
                            <div class="step" id="step-1">
                                <div class="step-icon">âœ”</div>
                                <div class="step-info">
                                    <h4>Registration</h4>
                                    <p class="text-start">Initial student information entry.</p>
                                </div>
                            </div>
                        
                            <!-- Step 2: Accounting Confirmation -->
                            <div class="step" id="step-2">
                                <div class="step-icon">âœ”</div>
                                <div class="step-info">
                                    <h4>Accounting Confirmation</h4>
                                    <p class="text-start">Verification of payment details and fee structure setup.</p>
                                </div>
                            </div>
                        
                            <!-- Step 3: Subject Selection -->
                            <div class="step" id="step-3">
                                <div class="step-icon">âœ”</div>
                                <div class="step-info">
                                    <h4>Subject Selection</h4>
                                    <p class="text-start">Choose academic subjects based on curriculum requirements.</p>
                                </div>
                            </div>
                        
                            <!-- Step 4: Section Selection -->
                            <div class="step" id="step-4">
                                <div class="step-icon">âœ”</div>
                                <div class="step-info">
                                    <h4>Section Selection</h4>
                                    <p class="text-start">Assignment to specific class sections and schedules.</p>
                                </div>
                            </div>
                        
                            <!-- Step 5: Confirmation -->
                            <div class="step" id="step-5">
                                <div class="step-icon">5</div>
                                <div class="step-info">
                                    <h4>Confirmation</h4>
                                    <p class="text-start">Final review and verification of all enrollment details.</p>
                                </div>
                            </div>
                        
                            <!-- Step 6: Registration Form Printing -->
                            <div class="step" id="step-6">
                                <div class="step-icon">6</div>
                                <div class="step-info">
                                    <h4>Registration Form Printing</h4>
                                    <p class="text-start">Generation of official enrollment documentation for records.</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        {% else %}
            <div class="d-flex justify-content-center">
                <div class="col-sm-12 gap-3 d-flex flex-column">
                    <div class="card registration-card py-5">
                        <div class="card-body">
                            <div class="alert alert-success" role="alert">
                            <p class="p-0 m-0">Your tagged subjects are being reviewed for approval.  You will receive an email from the school once your subject schedule is approved and confirmed.  Thank you for your patience.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        {% if confirmation.status == "Pending" %}
            <div class="d-flex justify-content-center">
                <div class="col-sm-6 gap-3 d-flex flex-column">
                    <div class="card registration-card py-5">
                        <div class="card-body">
                            <div class="alert alert-success" role="alert">
                            <p class="p-0 m-0">Your registration is currently under review.  Please wait for the school to email you with confirmation.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Registration Section -->
            <div class="d-flex justify-content-center">
                <div class="col-sm-6 gap-3 d-flex flex-column">
                <div class="card registration-card py-5">
                    <div class="card-body">
                        <div class="alert alert-success" role="alert">
                        
                        <h5>Student Registration Instructions</h5>

                        <ol>
                            <li>Enroll Online: Go to the school portal and register for enrollment.</li>
                            <li>Complete Form: Fill out the entire registration form.</li>
                            <li>Check Email (Approval): Wait for an email confirming Accounting approval.</li>
                            <li>Choose Section (If Approved): If approved, select your class section (see email for details).</li>
                        </ol>

                        <h5>Important Reminders:</h5>
                        <ul>
                            <li>Use a working email address.</li>
                            <li>Approval emails take time â€“ monitor your inbox.</li>
                            <li>Section selection is only possible after you receive the approval email.</li>
                        </ul>

                        <p>For any questions, contact the registration office.</p>
                        </div>

                        <form method="POST" action="{% url "register" %}" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <div class="">
                            <label for="regCourse" class="form-label">Course</label>
                            <select class="form-select" id="regCourse" name="regCourse" required>
                                <option selected disabled value="">Choose...</option>
                                {% for course in courses %}
                                <option value="{{course.id}}">{{course.course}}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select a valid course.
                            </div>
                            </div>

                            <div class="pt-2">
                            <label for="regSemester" class="form-label">Semester</label>
                            <select class="form-select" id="regSemester" name="regSemester" required>
                                <option selected disabled value="">Choose...</option>
                                <option value="1st Semester">1st Semester</option>
                                <option value="2nd Semester">2nd Semester</option>
                                <option value="3rd Semester">3rd Semester</option>
                                <option value="4th Semester">4th Semester</option>
                                <option value="5th Semester">5th Semester</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a valid semester.
                            </div>
                            </div>

                            <div class="d-flex justify-content-end pt-4">
                                <button type="submit" class="submit-button">Submit Registration</button>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<script>
    //Toggle Search
    function toggleSearch() {
        document.getElementById('searchContainer').classList.toggle('active');
      }

      let searchTimeout;

      function searchJO() {
          clearTimeout(searchTimeout); 

          searchTimeout = setTimeout(() => {
            handleJoSearch();
          }, 1000);
      }

      function handleJoSearch() {
          let input = document.getElementById("searchInput").value.toLowerCase();
          let subjects = document.querySelectorAll("#open-subject .subject-card");
      
          subjects.forEach(subject => {
              let subjectTitle = subject.querySelector(".subject-info h4").innerText.toLowerCase();
              let professorInfo = subject.querySelector(".subject-info p").innerText.toLowerCase();
      
              if (subjectTitle.includes(input) || professorInfo.includes(input)) {
                  subject.style.display = "block";
              } else {
                  subject.style.display = "none"; 
              }
          });
      }

      // Subject Toggle
      const addButtons = document.querySelectorAll('.view-subject');
      addButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const card = btn.closest('.subject-card');
          card.classList.toggle('open');

        });
      });
  
      // Enrollment progress
      document.addEventListener("DOMContentLoaded", function () {
        function fetchEnrollmentProgress() {
            fetch("/users/get_enrollment_progress/")
                .then(response => response.json())
                .then(data => updateProgressSteps(data))
                .catch(error => console.error("Error fetching enrollment progress:", error));
        }
    
        function updateProgressSteps(data) {
            const steps = document.querySelectorAll(".step");
            const status = [true, data.confirmation && data.accounting, data.subject, data.section, data.section_confirmation, data.print_regform];
    
            steps.forEach((step, index) => {
                if (status[index]) {
                    step.classList.add("completed");
                    step.querySelector(".step-icon").textContent = "âœ”";
                } else {
                    step.classList.remove("completed");
                    step.querySelector(".step-icon").textContent = index + 1;
                }
            });
        }
    
        fetchEnrollmentProgress();
        setInterval(fetchEnrollmentProgress, 5000);
    });s
    
    

</script>

{% endblock content %}